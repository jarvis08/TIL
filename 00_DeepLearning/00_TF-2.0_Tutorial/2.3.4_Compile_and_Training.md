# 2.3.4 Compile and Training

구성한 모델(Model)을 컴파일(Compile)하여 학습(Training)시키는 과정은 텐서플로(TensorFlow) 공식 홈페이지의 [Text Classification](https://www.tensorflow.org/beta/tutorials/keras/basic_text_classification_with_tfhub) 예시 코드를 기반으로 설명하겠습니다. 코드가 어떻게 사용되는가, 그리고 왜 사용되었는가를 공부하는 것은 매우 중요합니다. 작성자 본인의 경우 코드 공부를 병행하는 것이 이론을 가장 명확하게 이해할 수 있는 방법이었습니다.

## 컴파일

###컴파일 기능

Configures the model for training.

`model.compile()`은 사용자가 제작한 모델을 어떻게 학습시킬 것인지를 결정하는 모델 클래스의 메서드입니다. 학습 방법은 아래의 인자(Parameter)들을 조절하여 결정할 수 있습니다.

```python
compile(
    optimizer,
    loss=None,
    metrics=None,
    loss_weights=None,
    sample_weight_mode=None,
    weighted_metrics=None,
    target_tensors=None,
    distribute=None,
    **kwargs
)
```

그 중에서도 가장 중요한 세 가지 매개변수는 `optimizer`, `loss`, `metrics`입니다.

`optimizer` 는 주로 학습하는 변수의 변화량을 어떻게 학습에 적용할 것인가를 결정하며, 그 예로 Adam, SGD 등이 있습니다.

`loss`는 최적화 과정에서 최소화 시키는 손실 함수(loss function)를 설정합니다. 평균 제곱 오차(mse), cross entropy 등이 그 예시입니다.

`metrics`는 학습 과정을 모니터링 하기 위해 사용되며, accuracy와 같은 척도를 사용합니다.



### 컴파일 사용 예시

다음 코드 블록은 `model.compile()`의 사용 예시입니다.

```python
model.compile(optimizer=tf.keras.optimizers.Adam(0.01),
              loss='mse',
              metrics=['mae'])
```

위 코드는 모델을 Adam Optimizer를 사용하며 학습 변수의 변화를 평균 제곱 오차(mse)로 계산하고, 학습 성과를 평균 절댓값 오차로 나타나게 합니다.

```python
model.compile(optimizer=tf.keras.optimizers.RMSprop(0.01),
              loss=tf.keras.losses.CategoricalCrossentropy(),
              metrics=[tf.keras.metrics.CategoricalAccuracy()])
```

위 코드는 모델을 RMSprop(Root mean square prop)을 사용하여 최적화 하고, 크로스 엔트로피 손실 함수를 이용하여 변수의 변화량을 측정합니다. 그리고 분류 모델의 정확도를 계산하여 나타냅니다.



## Fit

### Fit 기능

Trains the model for a fixed number of epochs (iterations on a dataset).

```python
fit(
    x=None,
    y=None,
    batch_size=None,
    epochs=1,
    verbose=1,
    callbacks=None,
    validation_split=0.0,
    validation_data=None,
    shuffle=True,
    class_weight=None,
    sample_weight=None,
    initial_epoch=0,
    steps_per_epoch=None,
    validation_steps=None,
    validation_freq=1,
    max_queue_size=10,
    workers=1,
    use_multiprocessing=False,
    **kwargs
)
```

세 개의 중요한 매개변수인 `epochs`, `batch_size`, `validation_data`

- `epochs`: 훈련은 *에포크*(epoch)로 구성됩니다. 한 에포크는 전체 입력 데이터를 한번 순회하는 것입니다(작은 배치로 나누어 수행됩니다).
- `batch_size`: 넘파이 데이터를 전달하면 모델은 데이터를 작은 배치로 나누고 훈련 과정에서 이 배치를 순회합니다. 이 정수 값은 배치의 크기를 지정합니다. 전체 샘플 개수가 배치 크기로 나누어 떨어지지 않으면 마지막 배치의 크기는 더 작을 수 있습니다.
- `validation_data`: 모델의 프로토타입(prototype)을 만들 때는 검증 데이터(validation data)에서 간편하게 성능을 모니터링해야 합니다. 입력과 레이블(label)의 튜플을 이 매개변수로 전달하면 에포크가 끝날 때마다 추론 모드(inference mode)에서 전달된 데이터의 손실과 측정 지표를 출력합니다.



### fit 사용 예시

```python
model.fit(data, labels, epochs=10, batch_size=32)
```

다음의 코드 블록은 `validation_data`를  부여한 예시 코드입니다.

```python
model.fit(data, labels, epochs=10, batch_size=32,
          validation_data=(val_data, val_labels))
```



## fit_generator

### fit_generator 기능

Fits the model on data yielded batch-by-batch by a Python generator.

The generator is run in parallel to the model, for efficiency. For instance, this allows you to do real-time data augmentation on images on CPU in parallel to training your model on GPU.

The use of [`keras.utils.Sequence`](https://www.tensorflow.org/api_docs/python/tf/keras/utils/Sequence?hl=ko) guarantees the ordering and guarantees the single use of every input per epoch when using `use_multiprocessing=True`.

```python
fit_generator(
    generator,
    steps_per_epoch=None,
    epochs=1,
    verbose=1,
    callbacks=None,
    validation_data=None,
    validation_steps=None,
    validation_freq=1,
    class_weight=None,
    max_queue_size=10,
    workers=1,
    use_multiprocessing=False,
    shuffle=True,
    initial_epoch=0
)
```

